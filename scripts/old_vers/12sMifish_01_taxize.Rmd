---
title: "12s_Mifish_01_taxize"
author: "Kate Sheridan"
date: '2022-07-13'
output: html_document
---

This uses the Midori RDP classifier list
This will include more than fish, but 12S Mifish does pick up more than fish anyway.

The Midori classifier does have taxonomy built in, but we want the output to match the COI output, and especially WoRMS taxonomy. Assumedly, there will be a lot here with only OTT codes as few of the non-fish vertebrates will be marine.

```{r setup, include=FALSE}
library(tidyverse)
library(stringr)
library(taxize)
library(here)

# here filepaths
hakai_blast <- here('species_lists', 'hakai')
rosetta <- here('species_lists', 'hakai', '2022rosetta')
```

```{r load-in}
# from midori-rdp assignments
midori <- read_csv(here(hakai_blast,'2021_blast-db', '20211216_midori_all_sp.csv'))

# ncbi extract: 12S and fish
ncbi_fish <- read_csv(here(hakai_blast, '2022_ncbi', '20221102_ncbi_fish_rough.csv'), 
                      col_names = FALSE)


```

```{r classify-exand}
# classify expand function
classify_expand <- function(classifyobject) {
  expanded_classify <- classifyobject %>% 
  compact() %>%
  #discard( ~ nrow(.x) == 0) %>% # this caused issues in some of the lists?
  map_dfr( ~ data.frame(.x), .id = 'query') %>%
  filter(!(rank == 'no rank')) %>%
  pivot_wider(id_cols = query, names_from = rank, values_from = c(name, id)) %>%
  rename_with(~ str_replace(.x, 'name_', '')) %>%
  rename_with(~ str_replace(.x, 'id_', 'ottid_')) %>%
  select(query, domain, kingdom, phylum, class, subclass, 
         order, family, genus, species, ottid_species) %>%
  # some of these come back with c() inside the cells, we'll unbind them
  mutate(across(.fns = ~gsub('c\\(|\\)', '', .))) %>%
  mutate(across(.fns = ~gsub('\"', '', .))) %>%
  separate_rows(phylum, class, subclass, order, family, 
                genus, species, ottid_species,
                sep = ", ") %>%
    distinct() %>%
    mutate(across(.cols = everything(), ~str_replace_all(., 'NULL', NA_character_)))
  return(expanded_classify)
}
```


```{r worms-function}
library(worrms)

## requires worrms to be loaded
# input is vector of species names
# use wm_records_names to extract 
# this doesn't need the + signs

# right now this breaks if not-found
search_records_worms <- function(spnames) {
  search <- tibble()
  for (i in spnames) {
    print(paste0('searching for ', i))
    record <- wm_records_names(i, marine_only = FALSE)
    message('done')
    search <- append(search, record)
  }
  names(search) <- spnames
  search_output <- map_dfr(.x = search, ~ data.frame(.x), .id = 'query') %>%
    janitor::clean_names() %>%
    select(!(c(url, taxon_rank_id, citation, lsid, modified)))
  return(search_output)
}
```



If needed, such as with the NCBI fish
```{r format input}
ncbi_fish <- ncbi_fish %>%
  select(X1) %>%
  distinct() %>%
  rename(species = X1)
```

Change object going in to whatever you loaded in

## clean ncbi

```{r ncbi-clean}
fish_key <- ncbi_fish %>%
  select(species) %>% 
  #mutate(species_orig = species) %>%
  mutate(species = trimws(species)) %>%
  # remove brackets and special characters
  mutate(species = str_remove_all(species, "\\[")) %>%
  mutate(species = str_remove_all(species, "\\]")) %>%
  mutate(species = str_remove_all(species, "\\(")) %>%
  mutate(species = str_remove_all(species, "\\)")) %>%
  mutate(species = str_remove_all(species, "\\'")) %>%
  mutate(species = str_remove_all(species, "#")) %>%
  mutate(species = str_remove_all(species, "/")) %>%
  mutate(species = str_remove_all(species, ">")) %>%
  mutate(species = str_remove_all(species, "&")) %>%
  # remove 'sp'
  mutate(species = trimws(species)) %>%
    # species
  mutate(species = str_remove_all(species, "(sp\\. )|(sp\\.)$|( sp)$|(_sp_)|( sp[0-9])")) %>%
  # genus
  mutate(species = str_remove_all(species, "( Gen)|( gen n)|( gen)$|( gen\\. )|( gen )|( fam\\.)")) %>%
  # species complexes
  mutate(species = str_remove_all(species, "(cf\\. )|( cf)|( aff\\.)|^(aff\\. )|( species complex)|( Group )|( group )|( group)$|( gr\\.)|( complex)$|( complex )|( complex type)|( complexnew)|( complexc)|( var\\.)|( Var)$|( clade [A-Z]{1} )|( clade[0-9]{1})|( clade )|( clade)$|( nr\\.)|( unid\\.)|( und)$|( undet)$|( und_[0-9]{1})$|( unk)$|( unk_[0-9]{1})$| unnamed| sensu lato|  sesu lato|  sensu stricto|( intermediate )")) %>%
  # other taxonomy modifier
  mutate(species = str_remove_all(species, "( type )|(type[0-9]{2})|( type)$|( n\\.)|( n )|( new)$|( nov\\.)|( nov )|(nomen nudum)")) %>%
  mutate(species = str_remove_all(species, " genotype| ecotype| morphotype| voucher| specimen| popvariant| museum| ( et al)| field number|( sensu)| lineage| hybrid|( wild)|( var)$|(Natural )|( breed)|(mutant)$")) %>%
  # other meta-descriptors
  mutate(species = str_remove_all(species, "( collection)|( library)| Library| containing|( domain of)|( major)$|(_sample_)")) %>%
  # ways to say "fish"
  mutate(species = str_remove_all(species, "( efish)$|(eFish)$|(Fish)$|(Fisk)$|(Ichthyology)|(Ich)$|( IDEAFish)")) %>%
  # remove all numbers
  mutate(species = str_remove_all(species, "[0-9]")) %>%
  mutate(species = trimws(species)) %>%
  #remove the last character if its a capital letter many times
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  # in case multiple 'words'
  mutate(species = trimws(species)) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  #any sp that is left?
  mutate(species = str_remove_all(species, "( sp)$")) %>%
  mutate(species = trimws(species)) %>%
    # Genetics words
  mutate(species = str_remove_all(species, "mitochondrial|mitochondria|mitochodrial|mitochondral| cytochrome| oxidase| subunit|(cytb)| intergenetic| spacer| region| dehydrogenase| ribosomal| molecule| Clonal")) %>%
  # Methods
  mutate(species = str_remove_all(species, "( Miseq)| RNAThr|(Zap Express)|( Photo)$| environmental sample")) %>%
  # morphology
  mutate(species = str_remove_all(species, "( spot)|( spot)|( barred)|( dwarf)|( large )|( small )| Cribrimorphlike|( pinnules)|( crescent)$|( spiral)$|(collar)")) %>%
  mutate(species = str_remove_all(species, "( Head kidney)|(bulky head)|( brain)|( muscle)|( Tissue)|(Spleen of)|(gynotic )| infected|(prey of)|( larva)|( eyes)$| nudepalp|(palp)$")) %>%
  
  # color
  mutate(species = str_remove_all(species, "( Black)| black| chocolate|( Green)|( green)|( Red)|( red )|( rosy)|(Verde)$| orangecollar|( yellow)|( Yellow)|( yellowback)|( yellowcollar)|( yellowpatch)|( albino )|( white)|( White)| blond")) %>%
  
  # other animal names
  mutate(species = str_remove_all(species, "( Tuna)|( Perche)|( blackcarp)|( Eel)|( Salmon)|(Mackerel)| Puma Loach|( Porcupine)| sawfin shiner| brassy jumprock|( chimpanzeecA)|( gibbongA)|( ex Sooretamys angouya)$")) %>%
  
  mutate(species = trimws(species)) %>%
  # specific strings that are left
  mutate(species = str_remove_all(species, "( AHSp)$")) %>%
  mutate(species = str_remove_all(species, "( Aana)")) %>%
  mutate(species = str_remove_all(species, "( Aa )|( aa)$")) %>%
  mutate(species = str_remove_all(species, "( Ab )")) %>%
  mutate(species = str_remove_all(species, "( Ac)$")) %>%
  mutate(species = str_remove_all(species, "( Al )")) %>%
  mutate(species = str_remove_all(species, "( Am )")) %>%
  mutate(species = str_remove_all(species, "( As )")) %>%
  mutate(species = str_remove_all(species, "( At)$|( Av)$")) %>%
  mutate(species = str_remove_all(species, "( Ata)$")) %>%
  mutate(species = str_remove_all(species, "( Asp)")) %>%
  mutate(species = str_remove_all(species, "( Alg)$")) %>%
  mutate(species = str_remove_all(species, "( Aqu)$")) %>%
  mutate(species = str_remove_all(species, "(Ain)$")) %>%
  mutate(species = str_remove_all(species, "(Alg)$")) %>%
  mutate(species = str_remove_all(species, "(abyk)")) %>%
  mutate(species = str_remove_all(species, "( AlAf)$")) %>%
  mutate(species = str_remove_all(species, "( AgAc)$")) %>%
  mutate(species = str_remove_all(species, "( Asup)$")) %>%
  mutate(species = str_remove_all(species, "( Avul)$")) %>%
  mutate(species = str_remove_all(species, "( Acebrev)")) %>%
  mutate(species = str_remove_all(species, "( Aceten)$")) %>%
  mutate(species = str_remove_all(species, "( Ampden)$")) %>%
  mutate(species = str_remove_all(species, "(AmpOce)$")) %>%
  mutate(species = str_remove_all(species, "( Apar)$")) %>%
  mutate(species = str_remove_all(species, "(AQAHSP )")) %>%
  mutate(species = str_remove_all(species, "(AQAHHK )")) %>%
  mutate(species = str_remove_all(species, "( ABPExPi)$")) %>%
  mutate(species = str_remove_all(species, "( ABYZlZong)$")) %>%
  mutate(species = str_remove_all(species, "( ARAMEr)$")) %>%
  mutate(species = str_remove_all(species, "( BimB )")) %>%
  mutate(species = str_remove_all(species, "(Bl)$|( bn)$|( bl)$|( bw)$|( bac)$|( Bus)$")) %>%
  mutate(species = str_remove_all(species, "(Blk)$")) %>%
  mutate(species = str_remove_all(species, "(Br)$")) %>%
  mutate(species = str_remove_all(species, "( CAhyb)$")) %>%
  mutate(species = str_remove_all(species, "( Cobs)$")) %>%
  mutate(species = str_remove_all(species, "( Cplu)$")) %>%
  mutate(species = str_remove_all(species, "( Cpor)$")) %>%
  mutate(species = str_remove_all(species, "(Clike)")) %>%
  mutate(species = str_remove_all(species, "(Cmb)$")) %>%
  mutate(species = str_remove_all(species, "( compcseq)")) %>%
  mutate(species = str_remove_all(species, "( CrVb)|( Cr)$|(Cma)$|(Cp)$|( Chab)")) %>%
  mutate(species = str_remove_all(species, "( DaAm)$|( Dec)$|( dki)$|( dkic)|( dkiart)$|( dkisp)|( Dloop)$|( Dja)$")) %>%
  mutate(species = str_remove_all(species, "( Ec)$|( EcBa )|( EcCh)|( EcDa)|( EcHe)|( Epoe)|( Epol)|(EST )|( Er)$")) %>%
  mutate(species = str_remove_all(species, "( Era like)")) %>%
  mutate(species = str_remove_all(species, "( Eralike)")) %>%
  mutate(species = str_remove_all(species, "( EspeVRDwgs)")) %>%
  mutate(species = str_remove_all(species, "( fAloSap)|(fMegCyp)|(fMelBoe)")) %>%
  mutate(species = str_remove_all(species, "( fAngAng)")) %>%
  mutate(species = str_remove_all(species, "( fArcCen)")) %>%
  mutate(species = str_remove_all(species, "( fToxJac)")) %>%
  mutate(species = str_remove_all(species, "(FMNHICHTHYMWAqu)")) %>%
  mutate(species = str_remove_all(species, "( Fwa)$")) %>%
  mutate(species = str_remove_all(species, "( from )")) %>%
  mutate(species = str_remove_all(species, "(Gal)$|(Gad)$|(Gel)$|(Gcuv)")) %>%
  mutate(species = str_remove_all(species, "( Gcir)$")) %>%
  mutate(species = str_remove_all(species, "( gr)$")) %>%
  mutate(species = str_remove_all(species, "(GenM)")) %>%
  mutate(species = str_remove_all(species, "( Hmargsl)$")) %>%
  mutate(species = str_remove_all(species, "( Hyp)$|( horm)$|( Horm)$")) %>%
  mutate(species = str_remove_all(species, "(IOCASZXCT)")) %>%
  mutate(species = str_remove_all(species, "( kPetMar)$")) %>%
  mutate(species = str_remove_all(species, "(Ki)$")) %>%
  mutate(species = str_remove_all(species, "(Kr)$")) %>%
  mutate(species = str_remove_all(species, "( Liz)$|(Lis)$|( La)$|(Lau)$|(Lab)$|(Laf)|(Lra)$|(Lnas)")) %>%
  mutate(species = str_remove_all(species, "( Che)$")) %>%
  mutate(species = trimws(species)) %>%
  mutate(species = str_remove_all(species, "( like)$")) %>%
  mutate(species = str_remove_all(species, "( ma)$")) %>%
  mutate(species = str_remove_all(species, "( mb)$")) %>%
  mutate(species = str_remove_all(species, "(MedUp)")) %>%
  mutate(species = str_remove_all(species, "(MedUm)")) %>%
  mutate(species = str_remove_all(species, "( Mes)$|(MmHer)|(MmKor)|(MmLim)|(MmSar)|( mam)$|(Md)$|(Mo)$|(Mg)$|( Mat)$|(Mel )|( Mad)$|( Msm)|(MiSc)|( man)$|(MuMi)|(Mcan)")) %>%
  mutate(species = str_remove_all(species, "(Mparis)$")) %>%
  mutate(species = str_remove_all(species, "( n)$")) %>%
  mutate(species = str_remove_all(species, "( No)|(No)$|(NanHai)|( Neo)$|(Nbre)")) %>%
  mutate(species = str_remove_all(species, "( OsVs)|( OsMc)|(OsMe)|(OsMp)|(OsMs)|(OsVf)| (OsVb)|(OsVr)|(omV hr LPS)")) %>%
  mutate(species = str_remove_all(species, "( PePoAs)$")) %>%
  mutate(species = str_remove_all(species, "( Personal)")) %>%
  mutate(species = str_remove_all(species, "( pk)$")) %>%
  mutate(species = str_remove_all(species, "( pr)$")) %>%
  mutate(species = str_remove_all(species, "( Pro)$|( Po)$|( Par)$|(Pa)$|(Pb)$|( Phe)$")) %>%
  mutate(species = str_remove_all(species, "( pfAd)|(Pgla)|( pfpRn)")) %>%
  mutate(species = str_remove_all(species, "(Ra)$|(Re)$|(Rg)$|(Rs)$|(Rw)$|(Rlen)")) %>%
  mutate(species = str_remove_all(species, "(S   eral)$")) %>%
  mutate(species = str_remove_all(species, "( SCa)$|(Sx)$|( Sc)$")) %>%
  mutate(species = str_remove_all(species, "( SAc)")) %>%
  mutate(species = str_remove_all(species, "( SAg)")) %>%
  mutate(species = str_remove_all(species, "( SHo)|(Syd)$|( Sval)$|( Slew)")) %>%
  mutate(species = str_remove_all(species, "( SIm)$")) %>%
  mutate(species = str_remove_all(species, "( SSg)")) %>%
  mutate(species = str_remove_all(species, "( Ssp)")) %>%
  mutate(species = str_remove_all(species, "( Ste)$")) %>%
  mutate(species = str_remove_all(species, "( STi)$")) %>%
  mutate(species = str_remove_all(species, "( Tr)$|( trn)$|( trn )|(Tej)$|( Te)$|( Tk)$|( Tm)$( Tf)$|( Tq)$|( Tag)$|( Thr)|( Tht)$|( Thy )|( Thy)$|( Tru)$|( Truw)$|(TSUMAGUROSUJIHAZE)|(Twdate)( Tpra)$|( Tfla)$|( TrTp)$|( ThorAur)|( Tas)$|(TSA)")) %>%

  mutate(species = str_remove_all(species, "( Saca)$")) %>%
  mutate(species = str_remove_all(species, "( s Phe)")) %>%
  mutate(species = str_remove_all(species, "( s)$")) %>%
  mutate(species = str_remove_all(species, "( UMTGen)")) %>%
  mutate(species = str_remove_all(species, "( Val)")) %>%
  mutate(species = str_remove_all(species, "( Wah )")) %>%
  mutate(species = str_remove_all(species, "( wicor)$")) %>%
  mutate(species = str_remove_all(species, "( WThail)$")) %>%
  mutate(species = str_remove_all(species, "(Xin)$| XXsp")) %>%
  mutate(species = str_remove_all(species, "(Zch)$")) %>%
  mutate(species = str_remove_all(species, "(zjdm)$")) %>%
  mutate(species = str_remove_all(species, "(zjlq)$")) %>%
  mutate(species = str_remove_all(species, "(zgqg)$")) %>%
  mutate(species = str_remove_all(species, "(zjcq)$")) %>%
  mutate(species = str_remove_all(species, "( Zhangihb)")) %>%
  mutate(species = str_remove_all(species, "( [a-z]{1})$")) %>%
  mutate(species = str_remove_all(species, "^fossil")) %>%
  mutate(species = trimws(species)) %>%
  # very specific things
  mutate(species = str_remove_all(species, "(unnamed genus  penumbrata sensu Scoble)$")) %>%
  mutate(species = str_remove_all(species, "( Phantom)")) %>%
  # species epithets duplicated
  mutate(species = str_remove_all(species, "( Aalabamae)$|( Epinephelusmarginatus)$|( Mnegrosensis)|( Msplendida)|( Tmyops)$|(Mbrachyurus)$|(Lmicrochirus)$")) %>%
  mutate(species = str_remove_all(species, "(like mettl)")) %>%
  mutate(species = str_remove_all(species, "( j)$")) %>%
  
  mutate(species = trimws(species)) %>%
  # location modifiers
  mutate(species = str_remove_all(species, "(Lake )|( Lake)|( cave)$|( spring)$|( springs)$|( river )|( River)|( stream)|( Creek)|( creek)|( near )|( sea)$|( sea )|( Pool)|( pool)$|( City)|( reef )|( reef)$|( aquatic)$|( farm)|( Plateau)|( Bay)$")) %>%
  mutate(species = str_remove_all(species, "( Aquarium)| Province| province| state |(state)$|(plantation)$")) %>%
  mutate(species = str_remove_all(species, "(Western )|( South)")) %>%
  mutate(species = trimws(species)) %>%
  # localities (many pasted from the inverts document just to be safe)
  mutate(species = str_remove_all(species, "(Adan)$| Adirondacks|( Australia)$|(Great Australian Bight)| Azores| Andai| Akaebi| Acla| Argis| Austria| Antalaha| Albanien| Almenara")) %>%
  mutate(species = str_remove_all(species, "(Asalda)")) %>%
  mutate(species = str_remove_all(species, "( Aptepi)")) %>%
  mutate(species = str_remove_all(species, "(Asur)$")) %>%
  mutate(species = str_remove_all(species, "(Atran)$")) %>%
  mutate(species = str_remove_all(species, "(Anacri)$")) %>%

  mutate(species = str_remove_all(species, " Andai")) %>%
  mutate(species = str_remove_all(species, " Amamilevii")) %>%
  mutate(species = str_remove_all(species, " Achenwald")) %>%

  mutate(species = str_remove_all(species, " Bacharach")) %>%
  mutate(species = str_remove_all(species, " Beforana")) %>%
  mutate(species = str_remove_all(species, " Bangkok")) %>%
  mutate(species = str_remove_all(species, " Betampona")) %>%
  mutate(species = str_remove_all(species, " Blaubeuren")) %>%
  mutate(species = str_remove_all(species, " Blackmore")) %>%
  mutate(species = str_remove_all(species, " Biafra")) %>%
  mutate(species = str_remove_all(species, " Balkan")) %>%
  mutate(species = str_remove_all(species, " Balfole")) %>%
  mutate(species = str_remove_all(species, " Bangladesh")) %>%
  mutate(species = str_remove_all(species, " Bocas")) %>%
  mutate(species = str_remove_all(species, " Borneo")) %>%
  mutate(species = str_remove_all(species, " Bugwe")) %>%
  mutate(species = str_remove_all(species, "(Balhash)$")) %>%
  mutate(species = str_remove_all(species, "( Bafounda)")) %>%
  mutate(species = str_remove_all(species, "( Benin)|( Bidou)|( Bissiang)|( Bioko)|( Bundu)|( Bush)$|(Bitter)|(Bibavotou)|(Bioko)")) %>%

  mutate(species = str_remove_all(species, " Cambuta river")) %>%
  mutate(species = str_remove_all(species, " Cameta")) %>%
  mutate(species = str_remove_all(species, " casmbe")) %>%
  mutate(species = str_remove_all(species, "(Cape )|(China )|( Carib)$|( Cap Esterias)|(Chiba Museum)|(CabotCenter)| Continental| Cayman| Caracol| Calibasis| Chiriqui| Collier|( Caroline)| Contulmo")) %>%
  mutate(species = str_remove_all(species, " Dabaisha")) %>%
  mutate(species = str_remove_all(species, " Dorsey")) %>%
  mutate(species = str_remove_all(species, "( Daying)|( delaware)$")) %>%
  mutate(species = str_remove_all(species, "(Dinar)")) %>%
  mutate(species = str_remove_all(species, " Doeggingen")) %>%
  mutate(species = str_remove_all(species, " Dossenbach")) %>%
  mutate(species = str_remove_all(species, " Djevojacka")) %>%
  mutate(species = str_remove_all(species, " Dunlopustralia")) %>%
  mutate(species = str_remove_all(species, " Eberstadt| Essequibo| Edoumb| Eberl| Ekouk| (Epoma)$|( Elon)$|( Elta)")) %>%
  mutate(species = str_remove_all(species, " Farias")) %>%
  mutate(species = str_remove_all(species, " Faraway")) %>%
  mutate(species = str_remove_all(species, " Florida")) %>%
  mutate(species = str_remove_all(species, "( Fiji)")) %>%
  mutate(species = str_remove_all(species, " Ferry")) %>%
  mutate(species = str_remove_all(species, " France")) %>%
  mutate(species = str_remove_all(species, " Fujian")) %>%
  mutate(species = str_remove_all(species, " Fareteuiraahiti")) %>%
  mutate(species = str_remove_all(species, " Girona| Gekara|(Greece)$|Guangdong|Guangxi|Guizhou|( Garcia)")) %>%
  mutate(species = str_remove_all(species, " Gogdeliprings")) %>%
  mutate(species = str_remove_all(species, " Halton| Hunan")) %>%
  mutate(species = str_remove_all(species, " Harvey")) %>%
  mutate(species = str_remove_all(species, " Hungary")) %>%
  mutate(species = str_remove_all(species, "(Croatia)$")) %>%
  mutate(species = str_remove_all(species, "( Hanel)")) %>%
  mutate(species = str_remove_all(species, " Iguassub")) %>%
  mutate(species = str_remove_all(species, " Incheon")) %>%
  mutate(species = str_remove_all(species, " Ivoloina|( Israel)| Ikorodu| Inji| Ijebu Ode|(Italy)| Izumihaze")) %>%
  mutate(species = str_remove_all(species, " Johor")) %>%
  mutate(species = str_remove_all(species, "( Japan)")) %>%
  mutate(species = str_remove_all(species, "( Java)")) %>%
  mutate(species = str_remove_all(species, "(Jian Yang)| JekyllIs")) %>%
  mutate(species = str_remove_all(species, " Komono")) %>%
  mutate(species = str_remove_all(species, " Kinhole")) %>%
  mutate(species = str_remove_all(species, " Kawakatsu")) %>%
  mutate(species = str_remove_all(species, " Kolodyne")) %>%
  mutate(species = str_remove_all(species, "(Kirk)$|( Kocher)|(Kipar)|(Kribi)|(Kuckuk)$|(Katsutoshi Watanabe)|(Komonyatsushihaze)|(Khukh)| Karianga|(Kapinar)")) %>%
  mutate(species = str_remove_all(species, "( Lagos)|(Lebanon)$|( LoireLac)|(Liang Cao)|(Lobaye)| Lleida")) %>%

  mutate(species = str_remove_all(species, " Lake Ohrid")) %>%
  mutate(species = str_remove_all(species, " Lau Basin")) %>%
  mutate(species = str_remove_all(species, " Kermadec")) %>%
  mutate(species = str_remove_all(species, " Kongou")) %>%
  mutate(species = str_remove_all(species, " Lucien")) %>%
  mutate(species = str_remove_all(species, " Laguna de Labradores")) %>%
  mutate(species = str_remove_all(species, " Lagoa Caconde")) %>%
  mutate(species = str_remove_all(species, "( Laos)$| Liscau| Lisrun| Loisia| Lorch| Lilliput")) %>%
  mutate(species = str_remove_all(species, "( Last )")) %>%
  mutate(species = str_remove_all(species, "( Muerz)|( Malibo)| Mazinzi| Mfulgida| MinasBasin| MagdalenIs|( Mai)|( Mic)$|(Micnat)| MicRamrun| Mitsem| Madimba|(Madeira)| Mundemba| Machinda| Makuya|( Mexico)| Montenegro| Madagascar| Manjavacas| Makira| Martinique| Maranho| Moabi| Myanmar| Miya")) %>%
  mutate(species = str_remove_all(species, " Makouto| Meramec")) %>%

  mutate(species = str_remove_all(species, " Malpais Spring")) %>%
  mutate(species = str_remove_all(species, " Manjavacas")) %>%
  mutate(species = str_remove_all(species, " Makira")) %>%
  mutate(species = str_remove_all(species, " Mtahiti")) %>%
  mutate(species = str_remove_all(species, " Malili")) %>%
  mutate(species = str_remove_all(species, " Manombo")) %>%
  mutate(species = str_remove_all(species, " Moehren")) %>%
  mutate(species = str_remove_all(species, " Maranhao")) %>%
  mutate(species = str_remove_all(species, " Maracaibo")) %>%
  mutate(species = str_remove_all(species, " Mbam")) %>%
  mutate(species = str_remove_all(species, " Mehuin")) %>%
  mutate(species = str_remove_all(species, " Mile")) %>%
  mutate(species = str_remove_all(species, " Monobe")) %>%
  mutate(species = str_remove_all(species, "(Nazilli)$| Ndombe| Ngombe| Nguru| Ndop| Nakuru| Nakabo|( Negro)$| Nevada")) %>%
  mutate(species = str_remove_all(species, " Neckarrems")) %>%
  mutate(species = str_remove_all(species, " Oberminseln")) %>%
  mutate(species = str_remove_all(species, " Oheimb")) %>%
  mutate(species = str_remove_all(species, " Oyapock")) %>%
  mutate(species = str_remove_all(species, " Oshoro")) %>%
  mutate(species = str_remove_all(species, " Ogowe")) %>%
  mutate(species = str_remove_all(species, "(Okinawa Churashima Foundation)")) %>%
   mutate(species = str_remove_all(species, " Oregon")) %>%
  mutate(species = str_remove_all(species, " Oman")) %>%
  mutate(species = str_remove_all(species, " Oreobasis")) %>%
  mutate(species = str_remove_all(species, " orinocot")) %>%
  mutate(species = str_remove_all(species, " Orinoco")) %>%
  mutate(species = str_remove_all(species, " Police")) %>%
  mutate(species = str_remove_all(species, " Peru")) %>%
  mutate(species = str_remove_all(species, " Pakistan")) %>%
  mutate(species = str_remove_all(species, " Perlen")) %>%
  mutate(species = str_remove_all(species, " Persia")) %>%
  mutate(species = str_remove_all(species, " Pannawonica")) %>%
  mutate(species = str_remove_all(species, " Philippines")) %>%
  mutate(species = str_remove_all(species, " Paraguay")) %>%
  mutate(species = str_remove_all(species, " Pamisou")) %>%
  mutate(species = str_remove_all(species, " Pindare")) %>%
  mutate(species = str_remove_all(species, " Pohnpei| Palime| Pampang| Patrocnica| Patchogue| Pachon")) %>%
  mutate(species = str_remove_all(species, "( Palm Isls)$")) %>%
  mutate(species = str_remove_all(species, "(Portugal)")) %>%
  mutate(species = str_remove_all(species, "( India)$")) %>%
  mutate(species = str_remove_all(species, "(Rio Chirgua)")) %>%
  mutate(species = str_remove_all(species, "( Sac)$")) %>%
  mutate(species = str_remove_all(species, " Station")) %>%
  mutate(species = str_remove_all(species, "( Suji)|( Suiyo)|( Smith)$|( Stevens)|(Shibukawa)| Salsburger| Surinam| Stepian| Stepien|(Sanya)|(Spain)$|( sagami)|(Santa Clara)| Scorff| Sahiler")) %>%
  mutate(species = str_remove_all(species, "(Thalye)| tanukihaze")) %>%
  mutate(species = str_remove_all(species, "( Trabio)")) %>%
  mutate(species = str_remove_all(species, " Temuco")) %>%
  mutate(species = str_remove_all(species, " Tocantins")) %>%
  mutate(species = str_remove_all(species, " Tobogan")) %>%
  mutate(species = str_remove_all(species, " Tuirial")) %>%
  mutate(species = str_remove_all(species, " Tuirivang")) %>%
  mutate(species = str_remove_all(species, " Thailand")) %>%
  mutate(species = str_remove_all(species, " Tlawng")) %>%
  mutate(species = str_remove_all(species, " Taiwan")) %>%
  mutate(species = str_remove_all(species, " Tahiti")) %>%
  mutate(species = str_remove_all(species, " Tiscar")) %>%
  mutate(species = str_remove_all(species, " Tufi")) %>%
  mutate(species = str_remove_all(species, " Terryn")) %>%
  mutate(species = str_remove_all(species, "(Ural)$|(United Kingdom)|( Urocara)|( Ulimi)| Uruguay")) %>%
  mutate(species = str_remove_all(species, "(Venezuela)|( Vanpoe)")) %>%
  mutate(species = str_remove_all(species, "( Vanmar)")) %>%
  mutate(species = str_remove_all(species, "( Vanphi)")) %>%
  mutate(species = str_remove_all(species, "( Vanver)")) %>%
  mutate(species = str_remove_all(species, "(Wainwright)$|( Whitewater)")) %>%
  mutate(species = str_remove_all(species, "( Zagno)|( Zarco)|( Zhange)|(Zhang)$")) %>%
  # one more round of remove capitals for words that were further in
  mutate(species = trimws(species)) %>%
  mutate(species = str_remove_all(species, "( [a-z]{1})$")) %>%
  mutate(species = trimws(species)) %>%
  mutate(species = str_remove_all(species, "( s)$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = trimws(species)) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = trimws(species)) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_remove_all(species, "([A-Z])$")) %>%
  mutate(species = str_replace_all(species, 
                                   c('mycorrhizal symbiont of Neuwiedia veratrifolia' = 'Fungi',
                                     'mycorrhizal isolate' = 'Fungi',
                                     'orange sea anemone' = 'Actiniaria',
                                     'hormathiid anemone strain VenAnem' = 'Hormathiidae',
                                              'tophaceataAHIt' = 'tophaceata',
                                     'liliputanusg' = 'liliputanus'))) %>%
  # remove trailing whitespaces
  mutate(species = trimws(species)) %>%
  distinct()


```

## Search taxa


```{r search worms}
# if you still have the second column for troubleshooting
fish_search <- fish_key %>%
  select(species) %>%
  mutate(species = tolower(species)) %>%
  distinct() %>%
  ## temporary issue requires replacing whitespace with '+'
  mutate(worms_query = gsub(" ", "+", species))


#split into smaller sections to guarantee finishing

search1 <- fish_search[1:7000,]
search2 <- fish_search[7001:13513,]



# 2: worms
fish_worms <- get_wormsid_(sci_com = search1$worms_query)
# get_wormsid_ gives back null and length 0 elements
## first remove with compact and discard then map_dfr
fish_worms2 <- fish_worms %>% 
  compact() %>%
  discard( ~ nrow(.x) == 0) %>%
  map_dfr( ~ data.frame(.x), .id = 'query')


fish_worms <- get_wormsid_(sci_com = search2$worms_query)
# get_wormsid_ gives back null and length 0 elements
## first remove with compact and discard then map_dfr
fish_worms3 <- fish_worms %>% 
  compact() %>%
  discard( ~ nrow(.x) == 0) %>%
  map_dfr( ~ data.frame(.x), .id = 'query')


fish_worms_result <- bind_rows(fish_worms2, fish_worms3)


#~~~~ from other script

# this cleaning step is relatively temporary until they fix the curl issue
fish_worms_result <- fish_worms_result %>%
  left_join(fish_search, by = c('query' = 'worms_query')) %>%
  relocate(species) %>%
  select(!(query)) %>%
  mutate(species = str_to_sentence(species))

# now match species to sciname to remove extra rows
fish_worms_result <- fish_worms_result %>%
  # remove higher taxonomy with species-level hits
  filter(!(str_detect(species, " ") == FALSE & str_detect(scientificname, " ") == TRUE)) %>%
  #filter(!(str_detect(species, " ") == FALSE & !(species == scientificname))) %>%
  #filter(!(!(species == scientificname))) %>%
  select(!(c(status))) %>%
  rename(worms_aphiaid = AphiaID,
        worms_sciname = scientificname) %>%
  distinct()


# note here i'm pausing and doing a different strategy

# extract higher and info about freshwater
annelid_records <- search_records_worms(annelid_worms2$worms_sciname)

# refine results to be useful
annelid_records <- annelid_records %>%
  # only animal hits
  filter(kingdom == 'Animalia') %>%
  # generate terrestrial-only and freshwater-only columns
  mutate(freshwater_only = ifelse((is_marine %in% c(0, NA) ==TRUE) & (is_brackish %in% c(0,NA) == TRUE) & (is_freshwater == 1),  "1", "0")) %>%
    mutate(terrestrial_only = ifelse((is_marine %in% c(0, NA) ==TRUE) & (is_brackish %in% c(0,NA) == TRUE) & (is_terrestrial == 1),  "1", "0")) %>%
  distinct() %>%
  # rename to format
  rename(taxa_query = query,
         worms_aphiaid = valid_aphia_id,
         original_aphiaid =aphia_id,
         worms_match = scientificname,
         worms_sciname = valid_name
         ) %>%
  # remove unneeded columns
  select(!(c(authority, parent_name_usage_id, is_freshwater, 
             is_terrestrial, is_marine, is_brackish, is_extinct, match_type))) %>%
  relocate(c(worms_sciname, worms_aphiaid), .before = original_aphiaid) %>%
  # rank lowercase
  mutate(rank = tolower(rank))

```

### midori work

```{r search otl}
# if you still have the second column for troubleshooting
fish_search <- fish_key %>%
  select(species) %>%
  mutate(species = tolower(species)) %>%
  distinct()


#split into smaller sections to guarantee finishing

search1 <- fish_search[1:7000,]
search2 <- fish_search[7001:30000,]
#msearch3 <- midori_search[30001:60000,]
#msearch4 <- midori_search[60001:100000,]
#msearch5 <- midori_search[100001:140000,]
#msearch6 <- midori_search[140001:180000,]
#msearch7 <- midori_search[180001:210000,]
#msearch8 <- midori_search[210001:245519,]

#temp
#msearch9 <- midori_search %>%
#  filter(!(species %in% mresolved$search_string))


# resolve with open tree of life, all domains to filter out fungi, etc.
fish_resolved <- tol_resolve(search1$species) %>%
  mutate(search_string = str_to_sentence(search_string))


# manually set temp variables to merge later
#mresolved1 <- midori_resolved
#mresolved2 <- midori_resolved
#mresolved3 <- midori_resolved
#mresolved4 <- midori_resolved
#mresolved5 <- midori_resolved
#mresolved6 <- midori_resolved
#mresolved7 <- midori_resolved
mresolved8 <- midori_resolved
#temp
#mresolved9 <- midori_resolved


mresolved <- mresolved1 %>%
  bind_rows(mresolved2, mresolved3, mresolved4,
            mresolved5, mresolved6, mresolved7,
            mresolved8#, mresolved9
            )

#save intermediate just in case!
#write_rds(mresolved, here('temp_midori.rds'))
#mresolved <- readRDS(here('temp_midori.rds'))

# sort out unique names
mresolved_classify <- mresolved %>%
  filter(!(is.na(unique_name))) %>% 
  select(unique_name) %>%
  distinct()

#for some reason its a 'match.names' object 
mresolved_classify <- as.tibble(mresolved_classify)


# do the splitting-babysitting-thing again
mresolved_classify1 <- mresolved_classify[1:7000,]
mresolved_classify2a <- mresolved_classify[7001:20000,]
mresolved_classify2b <- mresolved_classify[21001:30000,]
mresolved_classify3a <- mresolved_classify[30001:40000,]
mresolved_classify3b <- mresolved_classify[40001:50000,]
mresolved_classify3c <- mresolved_classify[50001:60000,]
mresolved_classify4a <- mresolved_classify[60001:70000,]
mresolved_classify4b <- mresolved_classify[70001:80000,]
mresolved_classify4c <- mresolved_classify[80001:90000,]
mresolved_classify4d <- mresolved_classify[90001:100000,]
mresolved_classify5 <- mresolved_classify[100001:140000,]
mresolved_classify6 <- mresolved_classify[140001:180000,]
mresolved_classify7 <- mresolved_classify[180001:210000,]
mresolved_classify8 <- mresolved_classify[210001:238338,]

midori_classify <- classification(mresolved_classify4d$unique_name, db = 'tol')

# manually set temp variables to merge later
#mclassify1 <- midori_classify
#mclassify2a <- midori_classify
#mclassify2b <- midori_classify
#mclassify3a <- midori_classify
#mclassify3b <- midori_classify
#mclassify3c <- midori_classify
#mclassify4a <- midori_classify
#mclassify4b <- midori_classify
#mclassify4c <- midori_classify
mclassify4d <- midori_classify
#mclassify5 <- midori_classify
#mclassify6 <- midori_classify
#mclassify7 <- midori_classify
#mclassify8 <- midori_classify


#save temp versions in case it breaks again
#write_rds(mclassify1, here('temp_midori1.rds'))
#write_rds(mclassify2a, here('temp_midori2a.rds'))
#write_rds(mclassify2b, here('temp_midori2b.rds'))
#write_rds(mclassify3a, here('temp_midori3a.rds'))
#write_rds(mclassify3b, here('temp_midori3b.rds'))
#write_rds(mclassify3c, here('temp_midori3c.rds'))
#write_rds(mclassify4a, here('temp_midori4a.rds'))
#write_rds(mclassify4b, here('temp_midori4b.rds'))
#write_rds(mclassify4c, here('temp_midori4c.rds'))
write_rds(mclassify4d, here('temp_midori4d.rds'))
write_rds(mclassify5, here('temp_midori_c5.rds'))
write_rds(mclassify6, here('temp_midori_c6.rds'))
write_rds(mclassify7, here('temp_midori_c7.rds'))
write_rds(mclassify8, here('temp_midori_c8.rds'))


mclassify1 <- readRDS(here('temp_midori1.rds'))
mclassify2a <- readRDS(here('temp_midori2a.rds'))
mclassify2b <- readRDS(here('temp_midori2b.rds'))
mclassify3a <- readRDS(here('temp_midori3a.rds'))
mclassify3b <- readRDS(here('temp_midori3b.rds'))
mclassify3c <- readRDS(here('temp_midori3c.rds'))
mclassify4a <- readRDS(here('temp_midori4a.rds'))
mclassify4b <- readRDS(here('temp_midori4b.rds'))
mclassify4c <- readRDS(here('temp_midori4c.rds'))
mclassify4d <- readRDS(here('temp_midori4d.rds'))
mclassify5 <- readRDS(here('temp_midori_c5.rds'))
mclassify6 <- readRDS(here('temp_midori_c6.rds'))
mclassify7 <- readRDS(here('temp_midori_c7.rds'))
mclassify8 <- readRDS(here('temp_midori_c8.rds'))

# expand classificaction objects
mclassify1 <- classify_expand(mclassify1)
mclassify2a <- classify_expand(mclassify2a)
mclassify2b <- classify_expand(mclassify2b)
mclassify3a <- classify_expand(mclassify3a)
mclassify3b <- classify_expand(mclassify3b)
mclassify3c <- classify_expand(mclassify3c)
mclassify4a <- classify_expand(mclassify4a)
mclassify4b <- classify_expand(mclassify4b)
mclassify4c <- classify_expand(mclassify4c)
mclassify4d <- classify_expand(mclassify4d)
mclassify5 <- classify_expand(mclassify5)
mclassify6 <- classify_expand(mclassify6)
mclassify7 <- classify_expand(mclassify7)
mclassify8 <- classify_expand(mclassify8)



#bind rows and save again

mclassify_all <- mclassify1 %>%
  bind_rows(mclassify2a, mclassify2b, mclassify3a,
            mclassify3b, mclassify3c, mclassify4a,
            mclassify4b, mclassify4c, mclassify4d,
            mclassify5, mclassify6, mclassify7, mclassify8) %>%
  # clean up tol mess, nothing after the parentheses ever matters
  mutate(query = str_remove_all(query, '\\(.*')) %>%
  mutate(query = trimws(query)) %>%
    #remove duplicates, its ok if it isn't perfect
  distinct(query, kingdom, .keep_all = TRUE)

#write draft
write.csv(mclassify_all, here(rosetta, 'current_draft', '20220724_midori_taxonomy_all.csv'))
```

## Problems

Anything not found needs resolved
Here we're running what TOL didn't find through several databases to identify them. In the COI script, we would have run it through WORMS here but we don't have it filtered to marine species yet.
Anything found is classified by the respective database, because at this stage we're looking to filter out not-fish. Then the remaining fish will be stripped of higher taxonomy and run through worms.

```{r problems}
# read in draft if necessary
mclassify_all <- read_csv(here(rosetta, 'current_draft', '20220724_midori_taxonomy_all.csv'))[-1]

# extract 'failures'
mresolved_fail_full <- midori_search %>%
  filter(!(species %in% mclassify_all$query))

# object to use as rolling list
mresolved_fail <- mresolved_fail_full

# run through gbif instead
mresolve_gbif <- get_gbifid_(sci = mresolved_fail$species)

mresolve_gbif2 <- map_dfr(.x= mresolve_gbif, ~ data.frame(.x), .id = 'taxa_query') %>%
  filter(matchtype == 'EXACT') %>%
  # strip higher taxonomy from gbif bc it doesn't match worms/bold
  ## but keep keys!
  select(!(c(scientificname, status, confidence, matchtype, kingdomkey,
             # just keeping regular gbif key
             acceptedusagekey, phylumkey, orderkey,
             classkey, familykey, genuskey, specieskey,
             synonym, note))) %>%
    rename(gbif_key = usagekey,
         gbif_taxa = canonicalname)
  
mresolved_fail <- mresolved_fail %>%
  filter(!(species %in% mresolve_gbif2$taxa_query))

# run through BOLD
mresolve_bold <- get_boldid_(sci = mresolved_fail$species)

mresolve_bold2 <- map_dfr(.x= mresolve_bold, ~ data.frame(.x), .id = 'taxa_query') %>%
    rename(bold_taxa = input) %>%
  filter(!(is.na(taxid)))

# classify found with bold
mresolve_bold_classify <- classification(mresolve_bold2$bold_taxa, db = 'bold')

mresolve_bold_classify2 <- map_dfr(.x= mresolve_bold_classify, ~ data.frame(.x), 
                                   .id = 'taxa_query') %>%
  distinct() %>%
  pivot_wider(names_from = rank, values_from = name, id_cols = taxa_query) %>%
  # make sure animals are populated here, the others don't matter anyway.
  mutate(kingdom = case_when(phylum == 'Arthropoda' ~ 'Animalia',
                             phylum == 'Annelida' ~ 'Animalia',
                             phylum == 'Cnidaria' ~ 'Animalia',
                             phylum == 'Chordata' ~ 'Animalia',
                             phylum == 'Mollusca' ~ 'Animalia',
                             phylum == 'Nemertea' ~ 'Animalia',
                             phylum == 'Platyhelminthes' ~ 'Animalia',
                             phylum == 'Tardigrada' ~ 'Animalia',
                             phylum == 'Nematoda' ~ 'Animalia')) %>%
  mutate(rank = 'species')


mresolved_fail <- mresolved_fail %>%
  filter(!(species %in% mresolve_bold2$taxa_query))


# now we'll extract the first word in each taxa here, presumably the genus, and try searching that way.
## Many of these issues are with insects, and what really matters is that we can sort out insects from our results.

mresolved_fail_gen_full <- mresolved_fail %>%
  # extract genus names so we can test them
  separate(species, into = 'genus_split', " ", 1, 
           remove = FALSE, extra = 'drop') %>%
  # remove brackets?
  mutate(genus_split = str_remove_all(genus_split, "[\\[\\]]"))

#temp to use as rolling list
mresolved_fail_gen <- mresolved_fail_gen_full

fail_gen_search <- mresolved_fail_gen %>%
  select(genus_split)%>%
  distinct()

# run through gbif
mresolve_gbif_gen <- get_gbifid_(sci = fail_gen_search$genus_split)

#rotate and prep
mresolve_gbif_gen2 <- map_dfr(.x= mresolve_gbif_gen, ~ data.frame(.x), .id = 'taxa_query') %>%
  filter(matchtype == 'EXACT') %>%
  # strip higher taxonomy from gbif bc it doesn't match worms/bold
  ## but keep keys!
  select(!(c(scientificname, status, confidence, matchtype, kingdomkey,
             phylumkey, orderkey,
             classkey, familykey, genuskey,
             synonym, note))) %>%
    rename(gbif_key = usagekey,
         gbif_taxa = canonicalname,
         genus_split = taxa_query)
  
mresolved_gbif_gen3 <- mresolved_fail_gen %>%
  left_join(mresolve_gbif_gen2, by = 'genus_split') %>%
  filter(!(is.na(gbif_key))) %>%
  select(!(c(species.y, specieskey))) %>%
  rename(species = species.x)

mresolved_fail_gen <-mresolved_fail_gen %>%
  filter(!(genus_split %in% mresolved_gbif_gen3$genus_split))

fail_gen_search <- fail_gen_search %>%
  filter(genus_split %in% mresolved_fail_gen$genus_split)

# run through BOLD
mresolve_bold_gen <- get_boldid_(sci = fail_gen_search$genus_split)

mresolve_bold_gen2 <- map_dfr(.x= mresolve_bold_gen, ~ data.frame(.x), .id = 'taxa_query') %>%
    rename(bold_taxa = input) %>%
  filter(!(is.na(taxid))) %>%
  select(taxa_query) %>%
  distinct()

# classify found with bold
mresolve_bold_classify <- classification(mresolve_bold_gen12$taxa_query, db = 'bold')

mresolve_bold_classify_gen2 <- map_dfr(.x= mresolve_bold_classify, ~ data.frame(.x), 
                                   .id = 'taxa_query') %>%
  distinct() %>%
  pivot_wider(names_from = rank, values_from = name, id_cols = taxa_query) %>%
  rename(genus_split = taxa_query) %>%
  select(!(species)) %>%
  right_join(mresolved_fail_gen_full) %>%
  filter(!(is.na(phylum)))

mresolved_fail_gen <-mresolved_fail_gen %>%
  filter(!(genus_split %in% mresolve_bold_classify_gen2$genus_split))

fail_gen_search <- fail_gen_search %>%
  filter(genus_split %in% mresolved_fail_gen$genus_split)


# EOL
# eol has some of the ncbi entries that can be odd
## find ID's and classify
mresolve_eol_gen <- get_eolid_(fail_gen_search$genus_split)
mresolve_eol_gen2 <- map_dfr(.x= mresolve_eol_gen, ~ data.frame(.x), .id = 'taxa_query')

mresolve_eol_classify <- classification(mresolve_eol_gen2$eolid, db = 'eol')

# rotate and clean
mresolve_eol_class2 <- map_dfr(.x = mresolve_eol_classify, ~ data.frame(.x), .id = 'eolid') %>%
  # fix the entries that doesn't have ranks 
  mutate(rank = ifelse(name %in% c('Fungi', 'Plantae', 'Metazoa', 'Animalia', 'Viruses'), 'kingdom', rank)) %>%
  mutate(rank = ifelse(name %in% c('Arthropoda', 'Chordata'), 'phylum', rank)) %>%
  mutate(rank = ifelse(name %in% c('Insecta', 'Reptilia'), 'class', rank)) %>%
    mutate(rank = ifelse(name %in% c('Coleoptera'), 'order', rank)) %>%
  mutate(rank = ifelse(name %in% c('Disholandricus', 'Rossmanomyces',
                                   'Ornithuroscincus'), 'genus', rank)) %>%
  filter(rank %in% c('kingdom', 'phylum', 'class', 
                     'order', 'family', 'genus', 'species')) %>%
  select(!(c(id, `.x`))) %>%
  filter(!(name %in% c('Dipnotetrapodomorpha', 'Sarcopterygii'))) %>%
  distinct() %>%
  pivot_wider(id_cols = eolid, names_from = rank, values_from = name) %>%
  select(!(c(species))) %>%
  mutate(genus = str_remove_all(genus, " .*")) %>%
  distinct(genus, .keep_all = TRUE) %>%
  mutate(across(.cols = everything(), ~str_replace_all(., 'NULL', NA_character_))) %>%
  filter(!(is.na(genus))) %>%
  rename(genus_split = genus) %>%
  right_join(mresolved_fail_gen_full) %>%
  filter(!(is.na(eolid)))




# Combine all found lists
## NOTE this introduces errors with duplicates. 
## HOWEVER it is enough to filter to fish
mresolved_fail_gen2 <- mresolved_gbif_gen3 %>%
  bind_rows(mresolve_eol_class2, mresolve_bold_gen2) %>%
  select(!(c(gbif_key, acceptedusagekey, eolid, taxa_query))) %>%
  filter(genus_split == genus) %>%
  distinct(species, class, .keep_all = TRUE) %>%
  select(!(genus_split)) %>%
  bind_rows(mresolve_gbif2, mresolve_bold_classify2) %>%
  select(!(c(gbif_key, taxa_query, tribe, gbif_taxa, subfamily))) %>%
  filter(!(is.na(species))) %>%
  mutate(query = species)

## extract what's still failing to look at later
outstanding_fails <- mresolved_fail_full %>%
  filter(!(species %in% mresolved_fail_gen2$species))

write_csv(outstanding_fails, here(rosetta, 'problems',
                                  'not_found', '20220724_midori_mifish_notfound.csv'))

```

# combine problems and fixed
```{r}
midori_key2 <- midori_key %>%
  rename(query = species)

midori_all <- mclassify_all %>%
  bind_rows(mresolved_fail_gen2) %>%
  left_join(midori_key2) %>%
  relocate(species_verbatim)

write_csv(midori_all, here(rosetta, 'current_draft', '20220724_midori_all_draft.csv'))


# extract fish to fix up

midori_fish <- midori_all %>%
  filter(phylum == 'Chordata') %>%
  filter(class %in% c('Actinopteri', 'Chondrichthyes', 'Elasmobranchii',
                      'Dipnoi', 'Hyperotreti', 'Cladista', 'Myxini',
                      'Cephalaspidomorphi', NA)) %>%
  filter(!(order %in% c('Sauria')))

write_csv(midori_fish, here(rosetta, 'current_draft', '20220724_mifish_fish_filter.csv'))
```

