---
title: "hakai-rosetta"
author: "Kate Sheridan"
date: "8/6/2021"
output: html_document
---

# Setting up the master database and 'Rosetta Stone'

June 2022 note: as of right now I will need an updated database, etc. This script was dropped into taxonomy_keys from another repository with the output from the merge; as of today it is almost a year old. 
One adjustment I am making here is that this script will only be for the merging of files in the database(s). So it can be skipped entirely if an already-clean version of the merge exists.


```{r include=FALSE}
library(tidyverse)
library(dplyr)
library(stringr)
library(janitor)
library(data.table)
library(here)

# here filepaths
hakai_blast <- here('species_lists', 'hakai', '2021_blast-db')
rosetta <- here('species_lists', 'hakai', '2022rosetta')
```

## 1. Merging the multiple files comprising the Hakai Institute COI eDNA barcode database


Load-in for this database is relatively complicated. There are two sources -- the sequences from Hakai itself and the sequences from BOLD/NCBI. They have to be read in separately, combined, and higher taxonomy assigned. The files here were updated August 2021 and may need updating. 

It may take a while to load the bold_genbank files as they tend to be large. Also, it says that it contains the Hakai barcodes but I'm going to merge the two anyway, it seems to be either missing some or is having trouble finding them when I search.

```{r load-in}
#these are all Hakai's personally barcoded samples
#includes internal codes, taxonomic information, and collection locality
hakailist <- read.csv(here(hakai_blast,
                           'All_Hakai_Marine_Samples_March2021-WithCOI.csv')) %>% clean_names()

#this is their 2020 taxon mapping file from BOLD and Genbank
#there are no column names in this file
## update: this might actually be a newer file? compare to file above?
bold_genbank_taxa <- read.delim(here(hakai_blast,
                           'CO1.BOLD_genbank_combined.taxa_map.w_hakai_barcodes.sunday_lab.txt'))

not_mm <- read_csv(here(hakai_blast, 'not-marine-metazoa_db-filter.csv'))
```

## Filter lists

I'm heavily filtering the data I'm working with at the moment to taxa of interest = *marine metazoans*. I want to retain only sequences/identities from marine animals, as this is what we will be looking for in our eDNA. The rest will all be filtered out of analysis, or represents contamination/controls.

This list is exclusion instead of keep in the case that the database is expanded in the future. I can't predict what to keep later, but 'Japygidae' will never be marine, for instance.

NOTE: I have removed all birds (V6 == 'Aves') here. This may be undesirable. We will have to determine if there are birds we want to keep. I have also removed all insects (V6 == 'Insecta'), which may also be undesirable. I did not remove Acari as mites may show up in the data. However, it is not filtered to marine-only mites as I am not familiar with their taxonomy.

Organisms selected to filter are in a csv "not-marine-metazoa_db-filter.csv" which is separate from the regular key, as it is for filtering the database itself rather than BLAST results. I may need to make a longer version by unique accession number as entries with both bold and genbank IDs often have the two separated with a | rather than uniquely identified, but this will not change the key at just the taxonomy stage.


```{r clean-bold-genbank}
# extract problem entries
no_record <- bold_genbank_taxa %>%
  filter((is.na(kingdom)) | ((class == "" & genus == "")))  %>%
  select(accession, taxonID, phylum) %>% 
  separate(accession, into = c('accession_1','accession_2'), sep = '[|]', fill = 'right')

write.csv(no_record, here(rosetta, 'problems', 'not_found', '20220716_db_accessions_no-id.csv'))


bold_genbank_taxa2 <- bold_genbank_taxa %>%
  subset(kingdom == "Metazoa") %>%
  filter(!(phylum == "")) %>%
  filter(!(class == "" & genus == "")) %>%
  #filter for marine metazoa using list
  filter(!(class %in% not_mm$taxa | order %in% not_mm$taxa | family %in% not_mm$taxa))




glimpse(bold_genbank_taxa2)

unique(bold_genbank_taxa2$order)
```


The Hakai list also needs sorting. There are many extra columns that may not be needed, and there are a few algae to remove.

```{r sort hakailist}
#reduce number of columns for other kinds of analysis
hakailist <- hakailist %>%
  select(Identification, Process.ID, BIN, Catalog.Num, Collection.Date,
         Phylum, Class, Order, Family, Genus, Species, Sector, Lat, Lon)

#animals only, remove others
#again, an exclusion list instead of an inclusion list
not_animal <- c('Rhodophyta', 'Ochrophyta', 'Ciliophora')
hakailist <- hakailist %>%
  subset(!(Phylum %in% not_animal))
```

## Merge bold-genbank and Hakai

```{r merge boldgb and hakai}
#Despite trying several varieties of join the best way to do it here
bold_gb_hakai <- full_join(hakailist, bold_gb_marine)


# write if needed
#write.csv(bold_gb_hakai, here('hakaidata', '2021rosetta', 'raw',
 #                             '20210812_hakai_bold_gbif_database_raw.csv'))

```

## Make a clean species column

```{r clean columns}
#create a verbatimTaxonRank column to retain original ranks of species
bold_gb_hakai$verbatimTaxonRank <- bold_gb_hakai$Species


#clean species column with all extra identifiers removed via regex
#NOTE double escape for period special character: "\\."
## note note i think some of these made issues with the merged database; I need to rewrite this call
## maybe to str_remove_all in multiple rows?
bold_gb_hakai <- bold_gb_hakai %>%
  mutate(Species = str_replace_all(Species, c("sp\\.(.*)" = "sp\\.", "cf. " = "",
                                              "nr. " = "",  "aff. " = "",
                                              " var." = "", " n." = "",
                                               " complex (.*)" = "",
                                               " sensu (.*)" = "",
                                              " et al\\." = "",
                                              " [0-9]+" = "",
                                              " [A-Z]{2}(.*)" = "",
                                              " gen.(.*)" = "",
                                              " group" = "",
                                              " species" = "",
                                              " [A-Z]{1}[0-9]{1}" = "",
                                              " [A-Z]{1}" = "",
                                              " environmental sample" = "",
                                              "unclassified [a-zA-Z]+" = "",
                                              " [\\(][a-zA-Z]+[\\)]" = "")))

# fill kingdom and domain from merge
# DO NOT DO THIS IF NOT ALREADY FILTERED FOR METAZOA
bold_gb_hakai$Domain <- "Eukaryota"
bold_gb_hakai$Kingdom <- "Metazoa"
```

```{r read and write clean}
# write if needed
write.csv(bold_gb_hakai, here('hakaidata', '2021rosetta', 'raw', 
                              '20210812_hakai_bold_gbif_database_clean.csv'))

```
